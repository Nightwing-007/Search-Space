<!DOCTYPE html>
{% load static tailwind_tags %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI SearchLab</title>
    {% tailwind_css %}
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* A custom class for our "frosted glass" effect */
        .glassmorphism {
            background: rgba(30, 35, 71, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* For Safari */
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-[#0b0f29] text-gray-200 antialiased">
    <div class="flex h-screen">
        <aside class="w-80 glassmorphism p-6 flex flex-col space-y-6 overflow-y-auto">
    {% csrf_token %}  <h1 class="text-2xl font-bold text-center">AI SearchLab</h1>

            <div class="space-y-3">
                <h2 class="font-semibold text-gray-400 uppercase tracking-wider text-sm">Graph Setup</h2>
                <div class="space-y-2">
                    <label for="graph-file-input" class="text-sm font-medium">Upload Graph File (.json)</label>
                    <input type="file" id="graph-file-input" accept=".json" class="block w-full text-sm text-slate-500
                        file:mr-4 file:py-2 file:px-4 file:rounded-md
                        file:border-0 file:text-sm file:font-semibold
                        file:bg-violet-500 file:text-white
                        hover:file:bg-violet-600 cursor-pointer"/>
                </div>
            </div>

            <div class="space-y-3">
                <h2 class="font-semibold text-gray-400 uppercase tracking-wider text-sm">Search Configuration</h2>
                <div class="space-y-2">
                    <label for="algorithm-select" class="text-sm font-medium">Algorithm</label>
                        <select id="algorithm-select" class="w-full ...">
                            <option value="bfs">Breadth-First Search (BFS)</option>
                            <option value="dfs">Depth-First Search (DFS)</option>
                            <option value="dls">Depth-Limited Search (DLS)</option> <option value="iddfs">Iterative Deepening (IDDFS)</option> <option value="dijkstra">Dijkstra's Algorithm</option>
                            <option value="greedy">Greedy Best-First Search</option>
                            <option value="astar">A* Search</option>
                        </select>
                </div>
                <div id="depth-limit-container" class="space-y-2 hidden">
                    <label for="depth-limit-input" class="text-sm font-medium">Depth Limit</label>
                    <input type="number" id="depth-limit-input" value="3" class="w-full bg-[#1e2347] border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-violet-500 focus:outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-2">
                        <label for="start-node-input" class="text-sm font-medium">Start Node</label>
                        <input type="text" id="start-node-input" class="w-full bg-[#1e2347] border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-violet-500 focus:outline-none">
                    </div>
                    <div class="space-y-2">
                        <label for="goal-node-input" class="text-sm font-medium">Goal Node</label>
                        <input type="text" id="goal-node-input" class="w-full bg-[#1e2347] border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-violet-500 focus:outline-none">
                    </div>
                </div>
                <button id="run-search-btn" class="w-full bg-violet-600 hover:bg-violet-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-200">
                    Run Search
                </button>

                <div class="grid grid-cols-2 gap-4">
                    <button id="next-step-btn" disabled class="w-full bg-gray-500 cursor-not-allowed text-white font-bold py-2 px-4 rounded-md transition-all duration-200">
                        Next Step
                    </button>
                    <button id="reset-btn" disabled class="w-full bg-red-600 hover:bg-red-700 cursor-not-allowed text-white font-bold py-2 px-4 rounded-md transition-all duration-200">
                        Reset
                    </button>
                </div>
            </div>

            <div class="space-y-3">
                <h2 class="font-semibold text-gray-400 uppercase tracking-wider text-sm">Analysis & Logic</h2>
                 <div class="space-y-2">
                     <label for="rules-input" class="text-sm font-medium">Knowledge Base Rules</label>
                    <textarea id="rules-input" rows="2" class="w-full bg-[#1e2347] border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-violet-500 focus:outline-none" placeholder="e.g., AVOID(5)"></textarea>
                </div>
                <div class="flex items-center space-x-2">
                    <input type="number" id="clusters-input" value="3" class="w-1/2 bg-[#1e2347] border border-gray-600 rounded-md p-2 focus:ring-2 focus:ring-violet-500 focus:outline-none" placeholder="K">
                    <button id="find-clusters-btn" class="w-1/2 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md transition-all duration-200">
                        Find Clusters
                    </button>
                </div>
            </div>

            <div id="status-message" class="text-center text-sm text-yellow-400 h-5 mt-auto"></div>

        </aside>

        <main class="flex-1 p-6">
            <div id="graph-container" class="w-full h-full bg-[#161a38] rounded-lg border-2 border-dashed border-gray-700 overflow-hidden relative flex items-center justify-center">
                <p class="text-gray-500">Upload a graph file to begin.</p>
            </div>
        </main>
    </div>

    <script>
        // --- Element Selectors ---
        const graphFileInput = document.getElementById('graph-file-input');
        const algorithmSelect = document.getElementById('algorithm-select');
        const startNodeInput = document.getElementById('start-node-input');
        const goalNodeInput = document.getElementById('goal-node-input');
        const runSearchBtn = document.getElementById('run-search-btn');
        const graphContainer = document.getElementById('graph-container');
        const statusMessage = document.getElementById('status-message');
        const rulesInput = document.getElementById('rules-input');
        const nextStepBtn = document.getElementById('next-step-btn');
        const resetBtn = document.getElementById('reset-btn');

        // --- ADD THESE NEW SELECTORS ---
        const depthLimitContainer = document.getElementById('depth-limit-container');
        const depthLimitInput = document.getElementById('depth-limit-input');
        // --- END NEW SELECTORS ---

        let graphData = null;
        let vizState = {
            visitedOrder: [],
            path: [],
            currentIndex: 0,
            isComplete: true,
        };

        // --- UTILITY & RENDERING FUNCTIONS (Unchanged) ---
        function getCsrfToken() { return document.querySelector('input[name="csrfmiddlewaretoken"]').value; }
        function renderGraph() {
            if (!graphData || !graphData.nodes || !graphData.edges) {
                graphContainer.innerHTML = '<p class="text-gray-500 text-center">Upload a graph file to begin.</p>';
                return;
            }
            graphContainer.innerHTML = ''; const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%');
            let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
            Object.values(graphData.nodes).forEach(n => {
                if (n.x < minX) minX = n.x; if (n.x > maxX) maxX = n.x;
                if (n.y < minY) minY = n.y; if (n.y > maxY) maxY = n.y;
            });
            const padding = 50;
            svg.setAttribute('viewBox', `${minX - padding} ${minY - padding} ${(maxX - minX) + padding*2} ${(maxY - minY) + padding*2}`);
            graphContainer.appendChild(svg);
            const edgeGroup = document.createElementNS("http://www.w3.org/2000/svg", "g"); svg.appendChild(edgeGroup);
            graphData.edges.forEach(edge => {
                const [u, v] = edge; const nodeU = graphData.nodes[u]; const nodeV = graphData.nodes[v]; if (!nodeU || !nodeV) return;
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute('x1', nodeU.x); line.setAttribute('y1', nodeU.y); line.setAttribute('x2', nodeV.x); line.setAttribute('y2', nodeV.y);
                line.setAttribute('stroke', '#4A5568'); line.setAttribute('stroke-width', '2'); line.id = `edge-${u}-${v}`;
                edgeGroup.appendChild(line);
            });
            const nodeGroup = document.createElementNS("http://www.w3.org/2000/svg", "g"); svg.appendChild(nodeGroup);
            Object.keys(graphData.nodes).forEach(nodeId => {
                const node = graphData.nodes[nodeId]; const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.id = `node-${nodeId}`; g.style.cursor = 'pointer';
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute('cx', node.x); circle.setAttribute('cy', node.y); circle.setAttribute('r', '15');
                circle.setAttribute('fill', '#2D3748'); circle.setAttribute('stroke', '#A0AEC0'); circle.setAttribute('stroke-width', '2');
                circle.style.transition = 'fill 0.3s ease'; g.appendChild(circle);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute('x', node.x); text.setAttribute('y', node.y); text.setAttribute('text-anchor', 'middle');
                text.setAttribute('dy', '.3em'); text.setAttribute('fill', 'white'); text.setAttribute('font-size', '14px');
                text.textContent = nodeId; g.appendChild(text); nodeGroup.appendChild(g);
            });
        }

        // --- VISUALIZATION LOGIC (Unchanged) ---
        function setupVisualization(results) {
            vizState.visitedOrder = results.visited_order; vizState.path = results.path_to_goal;
            vizState.currentIndex = 0; vizState.isComplete = false;
            runSearchBtn.disabled = true; runSearchBtn.classList.add('cursor-not-allowed', 'bg-gray-500');
            nextStepBtn.disabled = false; nextStepBtn.classList.remove('cursor-not-allowed', 'bg-gray-500');
            nextStepBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            resetBtn.disabled = false; resetBtn.classList.remove('cursor-not-allowed');
            statusMessage.innerText = 'Ready! Click "Next Step" to begin.';
        }
        function handleNextStep() {
            if (vizState.isComplete) return;
            const nodeId = vizState.visitedOrder[vizState.currentIndex];
            const nodeElement = document.querySelector(`#node-${nodeId} circle`);
            if (nodeElement) { nodeElement.setAttribute('fill', '#6B46C1'); }
            statusMessage.innerText = `Step ${vizState.currentIndex + 1} / ${vizState.visitedOrder.length}: Visiting node ${nodeId}`;
            vizState.currentIndex++;
            if (vizState.currentIndex >= vizState.visitedOrder.length) {
                vizState.isComplete = true; nextStepBtn.disabled = true;
                nextStepBtn.classList.add('cursor-not-allowed', 'bg-gray-500');
                nextStepBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                highlightFinalPath();
            }
        }
        function highlightFinalPath() {
            if (vizState.path && vizState.path.length > 0) {
                statusMessage.innerText = 'Path found! Highlighting...';
                vizState.path.forEach(nodeId => {
                    const nodeElement = document.querySelector(`#node-${nodeId} circle`);
                    if (nodeElement) { nodeElement.setAttribute('fill', '#38A169'); }
                });
            } else { statusMessage.innerText = 'Search complete. No path found.'; }
        }
        function resetVisualization() {
            renderGraph();
            vizState = { visitedOrder: [], path: [], currentIndex: 0, isComplete: true };
            runSearchBtn.disabled = false; runSearchBtn.classList.remove('cursor-not-allowed', 'bg-gray-500');
            nextStepBtn.disabled = true; nextStepBtn.classList.add('cursor-not-allowed', 'bg-gray-500');
            nextStepBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            resetBtn.disabled = true; resetBtn.classList.add('cursor-not-allowed');
            statusMessage.innerText = '';
        }

        // --- EVENT LISTENERS ---
        graphFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try { graphData = JSON.parse(e.target.result); resetVisualization(); }
                catch (error) { statusMessage.innerText = 'Error: Invalid JSON file.'; graphData = null; }
            };
            reader.readAsText(file);
        });

        // --- ADD THIS NEW EVENT LISTENER ---
        algorithmSelect.addEventListener('change', () => {
            if (algorithmSelect.value === 'dls') {
                depthLimitContainer.classList.remove('hidden');
            } else {
                depthLimitContainer.classList.add('hidden');
            }
        });
        // --- END NEW EVENT LISTENER ---

        runSearchBtn.addEventListener('click', async () => {
            if (!graphData) {
                statusMessage.innerText = 'Please load a graph first.';
                return;
            }
            resetVisualization();

            // --- UPDATE THIS PAYLOAD OBJECT ---
            const payload = {
                graph_data: graphData,
                algorithm: algorithmSelect.value,
                start_node: startNodeInput.value,
                goal_node: goalNodeInput.value,
                rules: rulesInput.value,
                depth_limit: depthLimitInput.value // This line is now needed
            };
            // --- END PAYLOAD UPDATE ---

            statusMessage.innerText = `Fetching path from server...`;
            try {
                const response = await fetch('/api/run-search/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                    body: JSON.stringify(payload)
                });
                const results = await response.json();
                if (!response.ok) { throw new Error(results.message || 'Server error.'); }
                setupVisualization(results);
            } catch (error) {
                console.error("Search failed:", error);
                statusMessage.innerText = `Error: ${error.message}`;
            }
        });

        nextStepBtn.addEventListener('click', handleNextStep);
        resetBtn.addEventListener('click', resetVisualization);
        window.addEventListener('resize', renderGraph);
    </script>
</body>
</html>